id: spawn-amazon-ubuntu-instance
functions:
- id: tfrun
  image: vorteil/terraform:v1
  files:
  - key: main.tf
    scope: workflow
    type: plain
description: spawns a new amazon instance that returns the ip 
states:
  - id: spawn-amazon-instance
    type: action
    action:
      secrets: ["AMAZON_ACCESS_KEY", "AMAZON_SECRET_KEY"]
      function: tfrun
      input: |
        {
          "action": "apply",
          "args-on-init": ["-backend-config=address=http://localhost:8001/terraform_amazon_instance"],
          "variables": {
            "state-name": "terraform_amazon_instance",
            "amazon_access_key": .secrets.AMAZON_ACCESS_KEY,
            "amazon_secret_key": .secrets.AMAZON_SECRET_KEY
          }
        }
